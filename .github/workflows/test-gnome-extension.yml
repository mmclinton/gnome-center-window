name: Test GNOME Extension Compatibility

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || contains(github.event.head_commit.message, '[run-ci]')
    strategy:
      matrix:
        include:
          - gnome-version: 45
            fedora-tag: 39
          - gnome-version: 46
            fedora-tag: 40
          - gnome-version: 47
            fedora-tag: 41
          - gnome-version: 48
            fedora-tag: 42
          - gnome-version: 49
            fedora-tag: 43
    steps:
      - uses: actions/checkout@v4
      - name: Build Extension ZIP
        run: |
          glib-compile-schemas schemas/
          zip -r extension.zip metadata.json extension.js prefs.js schemas/
      - name: Build Custom Docker Image
        run: docker build --build-arg FEDORA_TAG=${{ matrix.fedora-tag }} -t gnome-test:${{ matrix.gnome-version }} -f Dockerfile .
      - name: Run Test in Container
        run: |
          docker run --rm -v $(pwd):/app --user root -e GNOME_VERSION=${{ matrix.gnome-version }} gnome-test:${{ matrix.gnome-version }} bash -c "
            gnome-extensions install /app/extension.zip --force
            gnome-extensions enable center-window@mmc
            weston --backend=headless-backend.so --socket=wayland-1 --width=1024 --height=768 > /tmp/weston.log 2>&1 &
            WESTON_PID=\$!
            sleep 10  # Wait for Weston to start
            export WAYLAND_DISPLAY=wayland-1
            export G_MESSAGES_DEBUG=all
            export MUTTER_DEBUG=all
            if [ \"\$GNOME_VERSION\" -ge 49 ]; then
              OPT='--devkit'
            else
              OPT='--nested'
            fi
            dbus-run-session -- gnome-shell \$OPT --wayland > /tmp/shell.log 2>&1 &
            SHELL_PID=\$!
            sleep 30
            kill \$SHELL_PID || true
            wait \$SHELL_PID || true
            kill \$WESTON_PID || true
            wait \$WESTON_PID || true
            cat /tmp/shell.log
            # Check for failures
            if [ ! -f /tmp/shell.log ] || grep -iqE 'error.*center-window@mmc|failed.*center-window@mmc|crash|extension.*failed|failed to|unable to|unknown option|cannot autolaunch' /tmp/shell.log; then
              echo 'Extension load failed - see logs'
              cp /tmp/shell.log /app/shell.log
              exit 1
            fi
            # Positive validation: Ensure extension was loaded
            if ! grep -iq 'center-window@mmc' /tmp/shell.log; then
              echo 'No evidence of extension loading - fail'
              cp /tmp/shell.log /app/shell.log
              exit 1
            fi
          "
      - name: Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-gnome-${{ matrix.gnome-version }}
          path: shell.log
